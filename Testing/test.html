<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href=""> -->
    <title>Testing Document</title>
    <style>
        img {
            width: 100%;
            max-width: 50px;
        }
    </style>
</head>

<body>
    <div id="testHere"></div>

</body>
<!-- <script src="../Testing/PlaylistJSONdata.js"></script> -->
<!-- <script src="../Testing/CityJSONdata.js"></script> -->
<script>
    var testDiv = document.getElementById('testHere');

    //var cityStore = JSON.parse(localStorage.getItem('cityData'));
    var cityStore = {};
    var newText = '';
    var genToken = '';




    //  ---- This section is the refresh token bit. Use curl supplied and get
    //curl -d "{\"refreshtoken\":\"REFRESH_TOKEN\"}" -H "Content-Type: application/json" -X POST https://api.chartmetric.com/api/token
    var refreshUrl = 'https://api.chartmetric.com/api/token';
    var refToken = "uC6sog7Tyf4sakW06bwLoWQmQTwugmzgINywzA0WD0MQQvfRZsK5ZhPssGsBBdoS"; //When we get this working, possibly hide  refresh token key 
    function refreshAPI() {
        fetch(refreshUrl, {
            method: "POST",
            headers: {
                "content-type": "application/json",
            },
            body: JSON.stringify({
                refreshtoken: refToken, //'uC6sog7Tyf4sakW06bwLoWQmQTwugmzgINywzA0WD0MQQvfRZsK5ZhPssGsBBdoS'// refToken ,
            })
        }).then(function (response) {
            return response.json();
        }).then(function (data) {
            console.log(data)
            genToken = "Bearer " + data.token,
                getTopTenApi('', 'shazam'); //'7060','shazam'
        }).catch(function (error) {
            console.log(error);
        });
    }
    // ----- End of refresh token ----- */

    function getTopTenApiOrig(cityCode, service) {
        //Allowed values for service: youtube, radio, shazam
        if (cityCode != '') {
            var cityParam = 'city/' + cityCode + '/'
        } else { var cityParam = 'city/*/' };
        if (service != '') {
            var serviceParam = service + '/'
        } else { var serviceParam = '' };

        var topTenUrl = 'https://api.chartmetric.com/api/' + cityParam + serviceParam + 'top-tracks'
        fetch(topTenUrl, {
            // method: 'GET',
            headers: {
                // 'Authorization':  token ,
                'Authorization': genToken,
                'content-type': 'application/json',
                // 'Cookie': 'connect.sid=s%3Ae3110c90-fb7a-11ec-a565-5785d2c2acdb.LrKo7YyeGXzDmsPEGIzDDHoV0qiXsSvKScfJooyX7p0',
                // 'Access-Control-Allow-Origin': 'http://127.0.0.1:5500',
                //  'Access-Control-Allow-Origin': 'https://api.chartmetric.com',
                //'scope': 'api',
            },
            //redirect: 'follow',
            // 'url': document.location
            //'Accept': 'application/json, text/plain',
            //'Content-Type': 'application/json'

            //s mode: "no-cors",
        }).then(function (response) {
            if (response.ok) {
                console.log('test response OK:');
                console.log(response);
                return response.json();
            }
            console.log('test response !OK:');
            console.log(response);
            throw response;
        }).then(function (data) {
            console.log(data);
            //testDiv.textContent = data;
            window.cityStore = data;
            makeDiv();
        }).catch(function (error) {
            console.warn(error);
        })
    };

    function getTopTenApi(service, countryCode, cityCode) {
        // Shazam
        // https://api.chartmetric.com/api/charts/shazam?date=2020-09-01&country_code=AU&city=Melbourne
        // Youtube
        // https://api.chartmetric.com/api/charts/youtube/tracks?date=2020-02-06&country_code=us&offset=0
        // Spotify
        // https://api.chartmetric.com/api/charts/spotify?date=2018-11-01&country_code=US&interval=daily&type=regional


        //Allowed values for service: youtube, radio, shazam
        if (cityCode != '') {
            var cityParam = 'city/' + cityCode + '/'
        } else { var cityParam = 'city/*/' };
        if (service != '') {
            var serviceParam = service + '/'
        } else { var serviceParam = '' };

        var topTenUrl = 'https://api.chartmetric.com/api/' + cityParam + serviceParam + 'top-tracks'
        fetch(topTenUrl, {
            // method: 'GET',
            headers: {
                // 'Authorization':  token ,
                'Authorization': genToken,
                'content-type': 'application/json',
                // 'Cookie': 'connect.sid=s%3Ae3110c90-fb7a-11ec-a565-5785d2c2acdb.LrKo7YyeGXzDmsPEGIzDDHoV0qiXsSvKScfJooyX7p0',
                // 'Access-Control-Allow-Origin': 'http://127.0.0.1:5500',
                //  'Access-Control-Allow-Origin': 'https://api.chartmetric.com',
                //'scope': 'api',
            },
            //redirect: 'follow',
            // 'url': document.location
            //'Accept': 'application/json, text/plain',
            //'Content-Type': 'application/json'

            //s mode: "no-cors",
        }).then(function (response) {
            if (response.ok) {
                console.log('test response OK:');
                console.log(response);
                return response.json();
            }
            console.log('test response !OK:');
            console.log(response);
            throw response;
        }).then(function (data) {
            console.log(data);
            //testDiv.textContent = data;
            window.cityStore = data;
            makeDiv();
        }).catch(function (error) {
            console.warn(error);
        })
    };


    function makeDiv() {
        for (i = 0; i < 10; i++) {

            newText +=
                (i + 1)
                + ": " +
                "<img src=" + cityStore.obj[i].image_url + " >"
                +
                '<b>' + cityStore.obj[i].name + ",</b> " + cityStore.obj[i].artist_names
                +
                "<br> ";
        }

        testDiv.innerHTML = newText;
    }

    refreshAPI()
</script>

</html>